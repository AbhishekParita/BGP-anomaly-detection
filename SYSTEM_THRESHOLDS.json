{
  "project": "BGP Anomaly Detection System",
  "description": "Comprehensive configuration of all system thresholds and parameters",
  "last_updated": "2026-01-09",
  "version": "1.0",
  
  "system_configuration": {
    "database": {
      "host": "localhost",
      "port": 5432,
      "database": "bgp_monitoring",
      "user": "postgres",
      "pool_size": 5,
      "max_overflow": 10
    },
    "kafka": {
      "bootstrap_servers": ["localhost:9092"],
      "topic": "bgp-stream",
      "auto_offset_reset": "latest",
      "enable_auto_commit": true,
      "max_block_ms": 5000
    },
    "logging": {
      "level": "INFO",
      "log_file_max_bytes": 10485760,
      "log_file_backup_count": 5
    }
  },

  "data_management": {
    "database_retention": {
      "max_records_per_table": 50000,
      "description": "Maximum records maintained in each table (auto-cleanup enabled)",
      "retention_days": 30,
      "cleanup_batch_size": 1000
    },
    "stream_processing": {
      "max_stream_records": 1000,
      "description": "Maximum records to stream from CSV at once",
      "stream_delay_seconds": 1,
      "detector_timeout_seconds": 300
    },
    "batch_processing": {
      "detector_batch_size": 100,
      "description": "Process data in batches for efficiency",
      "max_buffer_size": 1000,
      "processing_interval_seconds": 10
    }
  },

  "alert_severity_thresholds": {
    "description": "Alert severity levels based on composite score (0-3 scale)",
    "critical_threshold": 2.54,
    "high_threshold": 2.14,
    "medium_threshold": 1.82,
    "low_threshold": 1.58,
    "note": "Scores above threshold trigger corresponding alert severity"
  },

  "model_detection_thresholds": {
    "lstm_neural_network": {
      "model_path": "model_output/lstm/lstm_best.h5",
      "sequence_length": 10,
      "output_type": "continuous_score",
      "score_range": "0.0 to 1.0",
      "detection_threshold": 0.5,
      "description": "LSTM Autoencoder for sequence-based anomaly detection"
    },
    
    "isolation_forest": {
      "model_path": "model_output/isolation_forest.pkl",
      "output_type": "anomaly_score",
      "score_range": "-1.0 to 1.0",
      "detection_threshold": 0.5,
      "description": "Isolation Forest for statistical anomaly detection"
    },
    
    "heuristic_rules": {
      "output_type": "rule_based_score",
      "score_range": "0.0 to 1.0",
      "percentile_for_thresholds": 95,
      "description": "Rule-based detection using BGP domain knowledge",
      
      "default_thresholds": {
        "total_updates_threshold": 200,
        "withdrawal_ratio_threshold": 0.3,
        "flap_count_threshold": 50,
        "path_length_threshold": 8,
        "message_rate_threshold": 100,
        "session_resets_threshold": 3
      },
      
      "rules": {
        "rule_1_high_withdrawal_rate": {
          "name": "Withdrawal Storm",
          "parameter": "withdrawal_ratio",
          "threshold": 0.3,
          "description": "Withdrawals / Total Updates > 30%",
          "severity": "HIGH",
          "weight": 0.20
        },
        
        "rule_2_update_storm": {
          "name": "Update Storm",
          "parameter": "total_updates",
          "threshold": 200,
          "description": "Total BGP updates > 200 in 30-second window",
          "severity": "HIGH",
          "weight": 0.20
        },
        
        "rule_3_path_length_anomaly": {
          "name": "Path Length Anomaly",
          "parameter": "path_length",
          "threshold": 8,
          "description": "Average AS path length > 8 hops",
          "severity": "MEDIUM",
          "weight": 0.15
        },
        
        "rule_4_high_flap_rate": {
          "name": "High Flap Rate",
          "parameter": "flap_count",
          "threshold": 50,
          "description": "Route flaps (announcements + withdrawals) > 50 per window",
          "severity": "HIGH",
          "weight": 0.20
        },
        
        "rule_5_message_rate_spike": {
          "name": "Message Rate Spike",
          "parameter": "message_rate",
          "threshold": 100,
          "description": "BGP messages per minute > 100",
          "severity": "MEDIUM",
          "weight": 0.15
        },
        
        "rule_6_session_instability": {
          "name": "Session Instability",
          "parameter": "session_resets",
          "threshold": 3,
          "description": "BGP session resets > 3 per hour",
          "severity": "HIGH",
          "weight": 0.10
        }
      }
    }
  },

  "ensemble_voting": {
    "description": "Combines predictions from 3 models",
    "voting_strategy": "majority_voting",
    "num_models": 3,
    "models": ["lstm", "isolation_forest", "heuristic"],
    "anomaly_detection_rules": {
      "unanimous_anomaly": {
        "description": "All 3 models detect anomaly",
        "confidence": "very_high",
        "weight": 1.0
      },
      "two_model_consensus": {
        "description": "2 or more models detect anomaly",
        "confidence": "high",
        "weight": 0.8
      },
      "single_model_detection": {
        "description": "Only 1 model detects anomaly",
        "confidence": "low",
        "weight": 0.4
      }
    },
    "final_anomaly_threshold": {
      "description": "Anomaly flagged if consensus score >= this",
      "value": 0.5
    }
  },

  "model_drift_detection": {
    "drift_monitor_service": {
      "check_interval_seconds": 3600,
      "description": "How often drift is checked (1 hour)",
      "baseline_window_hours": 168,
      "description_baseline": "7 days of historical data for baseline",
      "current_window_hours": 24,
      "description_current": "Last 24 hours of data for comparison"
    },
    
    "lstm_drift_thresholds": {
      "score_shift": 0.15,
      "description_score_shift": "15% shift in mean anomaly score triggers drift",
      "anomaly_rate_change": 0.20,
      "description_anomaly_rate": "20% change in anomaly detection rate",
      "confidence_drop": 0.10,
      "description_confidence": "10% drop in model confidence (not actively used)"
    },
    
    "isolation_forest_drift_thresholds": {
      "score_shift": 0.15,
      "description_score_shift": "15% shift in mean anomaly score triggers drift",
      "anomaly_rate_change": 0.20,
      "description_anomaly_rate": "20% change in anomaly detection rate",
      "confidence_drop": 0.10,
      "description_confidence": "10% drop in model confidence (not actively used)"
    },
    
    "heuristic_drift_thresholds": {
      "anomaly_rate_change": 0.30,
      "description": "30% change in rule-based detection rate (higher threshold)",
      "quartile_shift": 0.15,
      "description_quartile": "15% shift in Q25, Q50, Q75 percentiles"
    },
    
    "drift_detection_methods": {
      "method_1_score_distribution_shift": {
        "formula": "|current_mean - baseline_mean| / (baseline_std + ε)",
        "description": "Normalized mean shift detection",
        "epsilon": 1e-6,
        "purpose": "Detects gradual model performance decay"
      },
      
      "method_2_anomaly_rate_change": {
        "formula": "|current_rate - baseline_rate| / (baseline_rate + ε)",
        "description": "Relative rate difference",
        "epsilon": 1e-6,
        "purpose": "Detects changes in decision boundaries"
      },
      
      "method_3_quartile_shift": {
        "formula": "mean(|Q25_current - Q25_baseline|, |Q50_current - Q50_baseline|, |Q75_current - Q75_baseline|)",
        "description": "Mean quartile deviation",
        "quantiles_tracked": [25, 50, 75, 90],
        "purpose": "Captures distribution shape changes"
      }
    },
    
    "automatic_retraining": {
      "lstm_retraining_time": "5-10 minutes",
      "isolation_forest_retraining_time": "30 seconds",
      "heuristic_retraining_time": "10 seconds",
      "strategy": "hot_swap_zero_downtime",
      "detection_continues_during_retraining": true
    }
  },

  "feature_aggregation": {
    "window_size_seconds": 30,
    "description": "Data aggregated in 30-second windows",
    "features_extracted": 9,
    "feature_list": [
      "total_updates",
      "announcements",
      "withdrawals",
      "unique_peers",
      "flap_count",
      "path_length_avg",
      "message_rate",
      "withdrawal_ratio",
      "session_resets"
    ]
  },

  "ml_model_configuration": {
    "lstm": {
      "model_file": "model_output/lstm/lstm_best.h5",
      "scaler_file": "model_output/scaler.pkl",
      "input_sequence_length": 10,
      "input_features": 9,
      "output_size": 1,
      "description": "LSTM Autoencoder with sequence length of 10 windows (300 seconds)"
    },
    
    "isolation_forest": {
      "model_file": "model_output/isolation_forest.pkl",
      "contamination_parameter": "auto",
      "n_estimators": 100,
      "description": "Isolation Forest ensemble method"
    },
    
    "scalers": {
      "feature_scaler": "model_output/scaler.pkl",
      "description": "StandardScaler for feature normalization"
    }
  },

  "cpu_memory_protection": {
    "tensorflow_cpu_threads": 1,
    "tensorflow_enable_onednn": false,
    "tensorflow_log_level": 3,
    "description": "TensorFlow configured for low CPU/memory usage",
    "detector_process_delay_seconds": 0.01,
    "description_delay": "Delay between message processing for CPU protection"
  },

  "database_tables_structure": {
    "bgp_messages": {
      "description": "Raw BGP updates",
      "auto_cleanup": true,
      "max_records": 50000,
      "retention_days": 30
    },
    "aggregated_features": {
      "description": "30-second aggregated features",
      "auto_cleanup": true,
      "max_records": 50000,
      "retention_days": 30
    },
    "ml_results": {
      "description": "Detection results from all 3 models + ensemble",
      "auto_cleanup": true,
      "max_records": 50000,
      "retention_days": 30
    },
    "drift_flags": {
      "description": "Drift detection events",
      "auto_cleanup": true,
      "max_records": 50000,
      "retention_days": 30
    },
    "drift_reports": {
      "description": "Detailed drift analysis reports",
      "auto_cleanup": true,
      "max_records": 50000,
      "retention_days": 30
    }
  },

  "rpki_validation": {
    "routinator_url": "http://127.0.0.1:3323",
    "routinator_timeout_seconds": 10.0,
    "description": "RPKI validation service (Routinator) configuration"
  },

  "service_parameters": {
    "feature_aggregator": {
      "processing_interval_seconds": 10,
      "batch_size": 100,
      "description": "Aggregates BGP data into 30-second windows"
    },
    
    "heuristic_detector": {
      "processing_interval_seconds": 10,
      "batch_size": 100,
      "description": "Applies rule-based detection"
    },
    
    "lstm_detector": {
      "processing_interval_seconds": 10,
      "batch_size": 100,
      "description": "Runs LSTM autoencoder for anomaly detection"
    },
    
    "isolation_forest_detector": {
      "processing_interval_seconds": 10,
      "batch_size": 100,
      "description": "Statistical anomaly detection using Isolation Forest"
    },
    
    "ensemble_coordinator": {
      "processing_interval_seconds": 10,
      "batch_size": 100,
      "description": "Combines predictions from all 3 models"
    },
    
    "correlation_engine": {
      "processing_interval_seconds": 10,
      "batch_size": 100,
      "description": "Correlates detections to reduce false positives"
    },
    
    "drift_monitor": {
      "check_interval_seconds": 3600,
      "description": "Monitors model drift (hourly checks)",
      "automatic_retraining": true
    },
    
    "ris_live_collector": {
      "description": "Collects real-time BGP data from RIPE RIS Live",
      "websocket_connection": "true",
      "data_source": "wss://ris-live.ripe.net/v1/stream/"
    }
  },

  "summary_statistics": {
    "total_services": 8,
    "total_models": 3,
    "total_heuristic_rules": 6,
    "total_thresholds_configured": 25,
    "auto_cleanup_enabled": true,
    "drift_detection_enabled": true,
    "automatic_retraining_enabled": true
  },

  "notes": {
    "1_data_latency": "5-10 minutes behind real-time (RIS Live latency)",
    "2_database_auto_cleanup": "Database automatically maintains 50,000 records per table max",
    "3_zero_downtime": "Model retraining happens without service interruption (hot-swap)",
    "4_adaptive_baselines": "Baselines recalculate after retraining to prevent cascading false positives",
    "5_multi_method_drift": "Uses 3 independent methods to reduce false positive drift detection",
    "6_rule_percentile": "Heuristic thresholds calculated from 95th percentile of data",
    "7_consensus_voting": "Ensemble flags anomaly if 2+ models agree (majority voting)",
    "8_all_thresholds_adjustable": "All values can be modified in config files and services"
  }
}
